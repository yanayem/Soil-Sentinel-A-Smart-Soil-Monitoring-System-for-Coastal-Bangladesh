{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Soil Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">

{% include 'sidebar.html' %}

<main class="md:ml-60 mt-16 p-8 space-y-8">

  <!-- ================= PROFILE CARD ================= -->
  <div
    class="bg-white dark:bg-gray-800/50 backdrop-blur-md
           rounded-2xl p-6 shadow-lg hover:shadow-2xl
           transition flex items-center gap-6"
  >
    <img
      {% if profile.profile_pic %}
        src="{{ profile.profile_pic.url }}"
      {% else %}
        src="https://www.w3schools.com/howto/img_avatar.png"
      {% endif %}
      class="w-32 h-32 rounded-full border-4
             border-blue-500 dark:border-green-500
             object-cover transition hover:scale-105"
      alt="Profile"
    />

    <div>
      <h2 class="text-2xl font-semibold">
        {{ user.first_name }} {{ user.last_name }}
      </h2>
      <p class="text-gray-600 dark:text-gray-400 mt-1">
        <i class="fas fa-envelope text-blue-500 dark:text-green-400"></i>
        {{ user.email }}
      </p>
    </div>
  </div>

  <!-- ================= LATEST READINGS ================= -->
  <div
    class="bg-white dark:bg-gray-800/50 backdrop-blur-md
           rounded-2xl p-6 shadow-lg hover:shadow-2xl
           transition max-w-[900px] mx-auto"
  >
    <h3 class="text-blue-600 dark:text-green-400 text-xl font-semibold flex gap-2">
      <i class="fas fa-tint"></i> Latest Moisture Readings
    </h3>

    <ul class="mt-4 space-y-2 text-gray-700 dark:text-gray-400">
      {% for reading in readings %}
      <li class="flex justify-between items-center">
        <div>
          <i class="fas fa-leaf text-blue-500 dark:text-green-400"></i>
          Field {{ reading.device.name|default:"-" }} :
          <span class="font-medium">{{ reading.moisture }}%</span>
        </div>
        <div class="text-xs">
          {{ reading.updated_at|date:"M d, Y H:i" }}
        </div>
      </li>
      {% empty %}
      <li>No moisture readings available</li>
      {% endfor %}
    </ul>
  </div>

  <!-- ================= GRAPH ================= -->
  <div
    class="bg-white dark:bg-gray-800/50 backdrop-blur-md
           rounded-2xl p-6 shadow-lg hover:shadow-2xl
           transition max-w-[900px] mx-auto"
  >
    <h3 class="text-blue-600 dark:text-green-400 text-xl font-semibold flex gap-2">
      <i class="fas fa-chart-line"></i> Moisture Graph
    </h3>

    <div class="mt-4 h-[320px]">
      <canvas id="moistureChart"></canvas>
    </div>
  </div>

</main>

<!-- ================= CHART SCRIPT ================= -->
<script>
  const ctx = document.getElementById("moistureChart").getContext("2d");
  let chart;

  function isDark() {
    return document.documentElement.classList.contains("dark");
  }

  function themeColors() {
    const dark = isDark();
    return {
      text: dark ? "#e5e7eb" : "#1f2937",
      grid: dark ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.08)",
      line: dark ? "#00ffb5" : "#2563eb",   // GREEN / BLUE
      fill: dark
        ? "rgba(0,255,181,0.2)"
        : "rgba(37,99,235,0.2)"
    };
  }

  async function loadChart() {
    try {
      const res = await fetch("{% url 'soildata:api_moisture' %}");
      const data = await res.json();

      const labels = data.readings.map(r => r.time).reverse();
      const values = data.readings.map(r => r.moisture).reverse();
      const c = themeColors();

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.data.datasets[0].borderColor = c.line;
        chart.data.datasets[0].backgroundColor = c.fill;
        chart.options.plugins.legend.labels.color = c.text;
        chart.options.scales.x.ticks.color = c.text;
        chart.options.scales.y.ticks.color = c.text;
        chart.options.scales.x.grid.color = c.grid;
        chart.options.scales.y.grid.color = c.grid;
        chart.update();
        return;
      }

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Moisture (%)",
            data: values,
            borderColor: c.line,
            backgroundColor: c.fill,
            fill: true,
            tension: 0.35,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: c.text } }
          },
          scales: {
            x: { ticks: { color: c.text }, grid: { color: c.grid } },
            y: {
              beginAtZero: true,
              ticks: { color: c.text },
              grid: { color: c.grid }
            }
          }
        }
      });

    } catch (e) {
      console.error("Chart error:", e);
    }
  }

  loadChart();
  setInterval(loadChart, 5000);

  new MutationObserver(loadChart)
    .observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });
</script>

</body>
</html>
